name: Rust

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Cache Cargo registry
      uses: actions/cache@v1
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-stable-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-stable-cargo-registry-
    - name: Cache Cargo index
      uses: actions/cache@v1
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-stable-cargo-index-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-stable-cargo-index-
    - name: Cache Cargo build
      uses: actions/cache@v1
      with:
        path: target/debug
        key: ${{ runner.os }}-stable-build-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-stable-build-target-
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      env:
        NASH_API_SECRET: eyJjaGlsZF9rZXlzIjp7Im0vNDQnLzAnLzAnLzAvMCI6eyJhZGRyZXNzIjoiMk10VTc4dkYyOHFSUXNtRXk4bUFlWDhrSm55NHd5U1VURFUiLCJjbGllbnRfc2VjcmV0X3NoYXJlIjoiOWQ3MGJkMGI0N2ZiZTk0NzFhYzZlYWM5YjYzYTM4OTJkZGE0NTZhMzU0Njc4ZWU0ODlhMTk3YjYwZTM0ZjFmMyIsInB1YmxpY19rZXkiOiIwMmI0NTAxNTVkOTI2NTU4M2ExZmJlYzNjYTU3MDE4NDcwNDI0MDc3MGZiNmNjMTI0M2MzOTA0ZTEzOGQ2NTRhM2MiLCJzZXJ2ZXJfc2VjcmV0X3NoYXJlX2VuY3J5cHRlZCI6IjFhYWIzMzNhOTlmMWM0NzgxZDlmYThmZWI3NDgxNDY5ODgyNzcyM2RiZjliNTMxMDE4NmViMmM0YmY1N2YzZGYwZDc1YTZmMjJmODAzNDc0NTVhNGZhMWJkN2Y4NDE5MzhmZDBiZTRkOGE4ODNmZmYxODExYWQ5ZTU1OWJhZjM0MTdhZWRmNDc0MTEwOTg2YzI2M2U1ZTRhMTUxZjMxYmNiODdiZjM1NGM2ZTM5MzYyNWRkM2M5OWQ1YjUwOTUwNWU5NzhmOTY1NjAwNWQ0N2NlY2Q1YjcwMjNhYTI5N2UzODNkMDBhNWU5Y2EzYjk1NWE5MDk5NjZiNTFhZDI1NzcwYjNkZTY3ZWEwN2UwMzQ5Zjk3YWIxZTFjZDdjMjhhMGZiZGZiOTAzM2RjMTkzMGFlNzhjYThjN2Q0ZmUxOGU3N2VhMWE3NTMyYzIwMzZkZWVkNDhkYmVkOWIxYjI5MDA0NTJlMTgzNjU0OGYzOGY0MTU1Yzg3YjM1N2MxNmZhMTJkMTc2ZjUwZDFjMWFmYWM5YjlmYWIyYWI4MGExZDJhNDM5NjkwMjk5MGU2Y2QxMzUwM2RjNDI0MDgzYWRmN2IwYzlmYzgyZTYxNDRmZDQ2MzQwMzQzNTYxYTM2ZWY1OTE3NWQ4ZWYzYjg4NWIwMjY4ZmIyZWYyZWU5OWM4MTE3OTBiYTVjY2ZmNWIxNzlhMmRjODYwZDllY2FkN2Y0YmFjNjQ0ODczNjJjZTFjYTUzNGY3ZWI3YWQ5MzFkMDIzNmZiZTcyNzg0NWU4ZWYwZjNiZjc0MmU2Y2U4OGI2MDI5OTFjMzUwYTA0ODBiODA5N2ZlNzNiYzFlZTg5MjQyM2MyZmY4YTk0MGE0ZDkyZmRjNTA3ZmY0ZjQzOTdiMGVmNjZjNDAyNjQzMWI3ZjdkMjRmOGY4Y2Q5ZDI0NTliNWExZDg4MmY4M2U2NTFlOGNiOWVkYTc0NmUxN2VlYjRmZDQ1NTEzZmVlNzA4MWMxM2RiNmVlMjMxZWRhNDQ4YTU1NWYxZTQ4MGFhZWY0Zjc1NzQ2NjEzOTVhNDA5YjMwMmE0ZjNlZjA4MzNmNjUyYmZlNjRmNzMwZGY5NDU1ZGZlNTE3Mjg1NDA1ZTcyNzE5NGEyYTBjNTVlMDI5NDM0Y2RkOGIwYjg2ZGU5M2QwYzJkMTRmMWI2YjQ2Y2E4ZGQ1MjhlMzJmZjg5ZjdiYjZiMTQwNTk5OTg1MzllZmMyNzQ4YzM1YjgyZDBmYzVjNGZhNjkzMGJjOTdkYzhiYWMyNTBhNzk2ZTk4NzVjZTE2NDBmOWE5M2I1ZDg3ZWViNTVjZDdhM2NjNjhkMzQ3ZTI0YTc0MmM3YWRkNzg3NzMyOGM5YjkifSwibS80NCcvNjAnLzAnLzAvMCI6eyJhZGRyZXNzIjoiMmEwYTg1ZTAwYmViYjU3NjIyNGJiNGE5MDAwZjAxOTYxNzAwNTQ4NiIsImNsaWVudF9zZWNyZXRfc2hhcmUiOiIzOWRkYzdmMzU5OTMzYWVhODI2ODE2NTRkYzA4M2RlYWJiNWJjNzcyNzM4ODVjNzNmYTQ1NTcxOGNmZDZiOTg5IiwicHVibGljX2tleSI6IjA0ODY0Njg1NWU4M2UzNDYzYWM0NzBkODRiMmQzOWY3Yzc0MTM5N2EzNGU5ZWEzNDQwZTM0Nzg5ZDU4YzU5Y2M4MzU0ZTE5YWExYmZjMzE5Y2I3MWRhNGJmOWU2ZWU2YTM3NDE5NTUxMDc1N2E4ZjU1NjJlNTZhZDIwYWI3YmI2MzYiLCJzZXJ2ZXJfc2VjcmV0X3NoYXJlX2VuY3J5cHRlZCI6IjFhMzg3YTJiZTI0YjViYmM4YWE4Yjg5NzhlMDhlMzE0NGI5OTg2NjQwYjZhOTk4MDQ3YThjMDdmYWU5ODQzM2IzYzZkMzVlYmE4MTA3ZTAzMTNhNjMzNWYxNWI1ZjA1N2UzNjFmZmFmMGEzZjhhMjU4YWY3MWMzZWIyMGY3MDYzZTkwMWQzNDI5OWUxODhlNTM3NjU5ZmI3NjY2NWEyODgxNmRmNDk5MDFhYTdiYTJlNTU1NDc2N2Q3OWE0ZGQ0NWYwZTU4MTMxNzVkY2NmMDIyNjQzNWI0YTk4ZmI4NmU3YTM3YjViZTI0MGRjZmRhYTIyZWIyMGI5ZmVlZTc0NzFjNmNiNWYxZWJkOGE0ZGIwYmRmYzAyZmQxYzNlOGY3NWFjMDVkZGFhZmY0NDkyNTQ1MTBmMTVkZDliOWVjMjdmMjI0MGE1OTFiMTc4YjVlMTY2YmIwNzg1NjA5YWExZDJlNjZkN2M0YTZiMTFhYTYzNTg2MzkwYTdjMTUxZTQ1NTQ4MGI3Y2U1MTA0MjQ5NDk3Njc5NDYyNDhmZmU3ZGYwZGJjYTQ2MGNjOWUzNDc2OWIzMjE2NDQ4ZWIxMWQ2OWRiYTNjYTFkZmU1ZmViODEzMTQzODE3ZTk5OTg0ZmNiZTA1MDA2NGQzMzZiYjkxMTlmNDg0ZDY3MzUwNDExM2NjOTNlNWQ1Y2YyMTYyOGIwMjA4NGY2YmZhNGQ4ZDdlMTBmODE2NDYxNDIxMTEyZGQ5NTIzNDA0ZWYwYjc2MGI5NjlmN2E1NjU1OTc4MGE4OWNjODFjZWEzNGY1ZTIxOThmZThkN2QwNTdlMTVhM2E4YTY4ODgxZjUxZjM4YTFiZDRmY2EzOThhMzNiZmMxOGFjODk1MDIwNWExZDYwYjdmOTE3ZWMyYTU1ODdmNGFiN2ZjZGI2ZWU5OWZmNjA4YjczODE2MjQzODBjOTczMjUyZWZiYTkwYmVmNzQzY2QzODFiYmQ0NjBiZDU1ODZmNmQxNmFmMzk1Y2I4NjRkM2FjODFmOTRjZjBlOTljZmU3MWJjNDgzZTJiZTM4MjVkY2UzYjg3NjE0MDBiNWRiYmJmZmMyMjQ4ZmRkNDg1ZmNmNmQ4MzYxOGYwY2IxYmFmZTY0M2JmMzA3N2IxZTk4NGM2ZjNkZWFkNzlkZjg4ODM5YjMzY2EwMDcwZGYyMTkwYmM2ZTYwODk1MmJlNzRhZmYxMjFhNzg5ZjE0MjIxYzJkYzRiYmU1ZGRhODFmMTQ1OWNlOWRiMGEwNTVmNjZhOWQwZGRlNDQ3ZmY1Njg5YTZkZjI0YTRjOTgwMWIxNjU5MGVlMzBkNWI1M2RkYjg4MzY3ZTEyZjM4MmJmYjEzODYzMzEifSwibS80NCcvODg4Jy8wJy8wLzAiOnsiYWRkcmVzcyI6IkFUeUhNQk5HWUZ5dVczYmNLbktCSEY2d045QVhUc0o4QmkiLCJjbGllbnRfc2VjcmV0X3NoYXJlIjoiMjI5YjIzNWIyZGIzZTBlNTQ0NGZkMDRjMGNlNzU4N2MzYzU5ZTEwNTM0ZDNiYzkwMGU5Nzg4MzZjYTI1NDMxZCIsInB1YmxpY19rZXkiOiIwMzVjN2RhNjUxMTk3ZDEzZDJjZjIzYzM3MTdlNmVkYTIxOWE2Yzk5MmUzOTI4ZmNiMmVmMjJiNWViOTRkNmQ3OWUiLCJzZXJ2ZXJfc2VjcmV0X3NoYXJlX2VuY3J5cHRlZCI6IjE2OGI2N2YzNjRjY2M2NTBmOWQzZmNmZjU2MGNiNTdhZjNkNDNhY2M2MzY4NDM5NGJlOTNkNjU3ZTNiMWMxZDc5YTE0MTRhMGE0MWJkNDZiYTJjMmU0MTlmNDRmODM5ZjBkN2Y3OWQ5M2UwOWExYmQ1ZDlhNWZlMjAzNzIzMjY4NjdjYWU3MjFiODk2ZmI3NGU5NjE4NjEwNDdiMjU5ODk3NWMxOGJmY2EyYzBjMTM4Zjk1NDhiZjE0NTMwYzMyNDdjOGViNTExYzUzMWZhNGI5NmRmZjEzMWI1ZDRjOTA4YzNmN2ZiMWQzM2QzOTc4YTY2ZjNmOWM4ZTc3MzU3NzgyOTRlNjFjMDU3NTVkNWI1NmY2MTU1ZjllNzlkNDUwZDk5NDFmMzk3NzczNWNjZjNjYzdkZTBhYWU1M2Q5NjE4MjQwZWNhMDQ1OTk1Mjk3NjM2N2EyMDkzZmE1ODQ4ZjFiZjQxMjE5M2M0OTI2MzkwMDI0MDM3ZDcyMGFmNTlkZTExOTU0NTU1NDE4YjEyYzYxYmNmZWVjYTYwZmI3OTcyMGM1ZmMyYTc0MjlkZjRmYWEwYmM0N2FmMTIyYTAyMzI1NjVhYzkxZTVjOWQ0YjYyMjc5NjAxNTdjYWY1YTE1MGE4NDk1MGNiMWM3NzZjM2FmMDVlODcwODM0YmE4ZDQ5MjVlM2RlMzY1ZmRlMzIzN2Q5YWQ5NDk4NmNkZDU3MjlhMDA4MjExOWE5Y2I3YmZlNTU4NTkwM2MzMzUzZjQ1MDA2MTBjYTU5ZTc4MTVmZTMwYjYwMjNhOTVjMjMxNWJiODdlYzEyNjI0ZTg0MjM3MzVkNDQ3ZGY4MTY3NGJkZDg0MzMzYjkyZjdlODY2MzM3MzAxNDYwYmU5ZTA4MmUyMTVjODUyOGJjZWExMTcwZTcyNzJkNzQ3ODU4YWZlNzFmZTNjNzZlNDYxN2JmNGZlZjg2ZDZiMDI5NGM5OGYwYzk5NTBlNjgxZWE0ODkzMWQ3YTU5ZDE5ZTg4ZjkzZGIwNjBhNTdjODA1ODI4ZGQxODQ3ODBiZGI1ZDRmNGEwYzk0ZmYwODI2NDkxYzk1M2E4M2VkMjczYTBhYTQwNzc2YjBlOWM5NTc0YTU4MjZkYjk1MWNmMGJmZTQxZWJkNTA0YjljZjFkOGJkNjk2ZjVhM2I2YjczNTFiZDY2YmUwMTYyMGI4YzBkOTA2MWMxMmM3ZWY3NGNjYjdhMTUzMjMyZjM0Nzk0ZDU0MTNjZGY0YmJkMGRkYmZkZDVhNDgwNmUxYTYwNjFjZjA3NzUyNTExMTlhZGJiMDg4OTMxY2RhMDlmMThkMjA0NDkyNGJiMmQ0YTJhNTM3N2NkZjZkNWJiMTUifX0sInBhaWxsaWVyX3BrIjp7Im4iOiI1OTg3ZTYyMjI2MWNhZjk2ZTI1ODI2YzcwY2YzMjNiMjYxOTRmZjljZmU2OWUzZjQwZjMwZDMwNjU3MTY0MmNhZWE4YTMxNDNkMTFmZjk0YzEzODgzNjA0ODY3MzU3YWU4YzBlNjYzYmYwM2QwMDkzMDE2ZDdmNGQ3OTBhZTI0ZTI5MTc4MDNkODEyYjY0MWFmMmQ2YzA5NTczZDExMmViNzY4NjQ2NTI5MWNkMTQ2ZmQ2NjJmNzdmNTk1ZWY4MzI3N2JlMTY4MGQwNDBiMWYzYzQ5OWM4MTkxNzU3MjA2ZTUxMGFlNTQ3MjRkNjY3ZmMwNDFhMmM3YzJmZjNkM2I2NmMzNzI5ZGMyNWUwMmM0MDE5ZWQzYTAxMmZkNzVlYzBlMDM5NDhjZjc4M2FkMzkwMmNlNWU1ZTcyMjI5YzNkZDNhMTRiOTM0ZDYwMjY5YWNiN2JhMGJkNDE1ZDJkZTEyOGVmMTg3MjI0MDBiYWVhMmU4NTBlNmQxZmQ4Nzg3YTAxMzBkNTE2MjA2ZDcxOGE0OWQ3YTIxZDQyOGIwZmEzNzczMDc5YjY0ODYxODExMTkxYjU1MDAxZDRjMmMyOWY2MzAzMTRiZTE5MWNmM2NhM2YwZjhlMDllZTA5NTQzZmZkZGEzZjk3Y2YxNjlkNTJlMDY3Y2ZkNDBjYjMwMzk0MSJ9LCJwYXlsb2FkX3B1YmxpY19rZXkiOiIwM2YxMGFjZDE5ZmU5YTkwZWZmODA0MzY1YzhhNzYxMTE5ODg3YjJkNjg3ZjQ2MGQzZWNhNzQyZTRlNGNhMWJlODEiLCJwYXlsb2FkX3NpZ25pbmdfa2V5IjoiYmJkM2YzNDI1MjUxNGZlYTJhYzg1OWYyNjkzYjFjOTNjNzk2ZDAyNDUzYTA1NGZmNmM5MzU5MDM5ZTBjNjBhMyIsInZlcnNpb24iOjB9
        NASH_API_KEY: ed4e890f-ef93-4b38-b1cc-29e4c4acab09
      run: cargo test --release -- --test-threads=1

  clippy_check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: actions-rs/toolchain@v1
        with:
            toolchain: nightly
            components: clippy
            override: true
      - uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  rustfmt_check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
            toolchain: stable
            components: rustfmt
            override: true
      - uses: mbrobbel/rustfmt-check@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
